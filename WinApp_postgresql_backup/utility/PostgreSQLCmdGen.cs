using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace WinApp_postgresql_backup.utility
{
    internal class PostgreSQLCmdGen
    {
        /// <summary>
        /// pg_dump,pg_restore実行中のパスワード入力を省略するためのファイルを作成
        /// "hostname:port:database:username:password"
        /// 33.15. パスワードファイル
        /// https://www.postgresql.jp/document/10/html/libpq-pgpass.html
        /// </summary>
        /// <param name="param"></param>
        public static void CreatePassFile(PostgresParam param)
        {

            string appdatadir = "";
            appdatadir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);

            string path = Path.Combine(appdatadir, "postgresql");
            Directory.CreateDirectory(path);

            path = Path.Combine(path, "pgpass.conf");

            string output = $"{param.Host}:{param.Port}:{param.DatabaseName}:{param.User}:{param.Pass}";
            //string output = String.Format("{0}:{1}:{2}:{3}:{4}",
            //    param.Host, param.Port, param.DatabaseName, param.User, param.Pass);

            using (StreamWriter sw = new StreamWriter(path))
            {
                sw.WriteLine(output);

                sw.Close();
            }

        }


        private static string GetTimestampString()
        {
            string ts = DateTime.Now.ToString("yyyyMMdd_HHmmss_fff");

            return ts;
        }

        /// <summary>
        /// pg_dumpの実行
        /// </summary>
        public static void Dump_cmd(Setting setting)
        {
            string ts = GetTimestampString();

            string destdir = setting.DumpPath;

            string cmdfilename = $"{ts}.pg_dump.bat";
            //string cmdfilename = string.Format("{0}.pg_dump.bat", ts);
            string cmdfilepath = Path.Combine(destdir, cmdfilename);

            string dumpfilename = $"{ts}.pg_dump";
            //string dumpfilename = string.Format("{0}.pg_dump", ts);
            string dumpfilepath = Path.Combine(destdir, dumpfilename);

            string dbbin = setting.DBinstallPath;

            string cd = $"cd {dbbin}";
            //string cd = String.Format("cd {0}", dbbin);

            string dump =
       $"pg_dump -h {setting.PGParam.Host} -p {setting.PGParam.Port} -U {setting.PGParam.User} -d {setting.PGParam.DatabaseName} -Fc -v -f {dumpfilepath}";
            //string dump =
            //    String.Format("pg_dump -h {0} -p {1} -U {2} -d {3} -Fc -v -f {4}",
            //    setting.PGParam.Host,
            //    setting.PGParam.Port,
            //    setting.PGParam.User,
            //    setting.PGParam.DatabaseName,
            //    dumpfilepath);

            List<string> cmdlist = new List<string>();

            cmdlist.Add(cd);
            cmdlist.Add(dump);
            cmdlist.Add("PAUSE");

            string cmd = string.Join(Environment.NewLine, cmdlist);

            execute_cmd(cmd, cmdfilepath);

        }

        private static void execute_cmd(string cmd, string cmdfilepath)
        {

            using (StreamWriter sw = new StreamWriter(cmdfilepath))
            {
                sw.WriteLine(cmd);
                sw.Close();
            }

            Process.Start(cmdfilepath);

        }

        /// <summary>
        /// pg_restoreの実行
        /// </summary>
        /// <param name="setting"></param>
        public static void Restore_cmd(Setting setting)
        {
            string restoredumpfilepath = setting.RestoreSourcePath;

            string ts = GetTimestampString();

            string cmdfilepath = restoredumpfilepath + ".restore.bat";

            PostgresParam param = setting.PGParam;

            string dbbin = setting.DBinstallPath;
            string cd = $"cd {dbbin}";
            //string cd = String.Format("cd {0}", dbbin);

            string restore =
    $"pg_restore --clean -h {param.Host} -p {param.Port} -U {param.User} -d {param.DatabaseName} {restoredumpfilepath}";
            //string restore =
            //    String.Format("pg_restore --clean -h {0} -p {1} -U {2} -d {3} {4}",
            //    param.Host, param.Port, param.User, param.DatabaseName, restoredumpfilepath);

            List<string> cmdlist = new List<string>();

            cmdlist.Add(cd);
            cmdlist.Add(restore);
            cmdlist.Add("PAUSE");

            string cmd = string.Join(Environment.NewLine, cmdlist);

            execute_cmd(cmd, cmdfilepath);

        }


    }
}
